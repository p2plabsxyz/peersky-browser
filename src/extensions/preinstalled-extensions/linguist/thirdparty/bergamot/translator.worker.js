var __assign=function(){return __assign=Object.assign||function(e){for(var r,t=1,n=arguments.length;t<n;t++)for(var a in r=arguments[t])Object.prototype.hasOwnProperty.call(r,a)&&(e[a]=r[a]);return e},__assign.apply(this,arguments)};function __awaiter(e,r,t,n){return new(t||(t=Promise))(function(a,o){function i(e){try{l(n.next(e))}catch(e){o(e)}}function s(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var r;e.done?a(e.value):(r=e.value,r instanceof t?r:new t(function(e){e(r)})).then(i,s)}l((n=n.apply(e,r||[])).next())})}function __generator(e,r){var t,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(t)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(i=0)),i;)try{if(t=1,n&&(a=2&s[0]?n.return:s[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,s[1])).done)return a;switch(n=0,a&&(s=[2&s[0],a.value]),s[0]){case 0:case 1:a=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,n=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!((a=(a=i.trys).length>0&&a[a.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!a||s[1]>a[0]&&s[1]<a[3])){i.label=s[1];break}if(6===s[0]&&i.label<a[1]){i.label=a[1],a=s;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(s);break}a[2]&&i.ops.pop(),i.trys.pop();continue}s=r.call(e,i)}catch(e){s=[6,e],n=0}finally{t=a=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}function __read(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,a,o=t.call(e),i=[];try{for(;(void 0===r||r-- >0)&&!(n=o.next()).done;)i.push(n.value)}catch(e){a={error:e}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(a)throw a.error}}return i}function __spreadArray(e,r,t){if(t||2===arguments.length)for(var n,a=0,o=r.length;a<o;a++)!n&&a in r||(n||(n=Array.prototype.slice.call(r,0,a)),n[a]=r[a]);return e.concat(n||Array.prototype.slice.call(r))}var YAML=function(){function e(){}return e.parse=function(e){var r={};return e.split("\n").forEach(function(e,t){var n;if(n=e.match(/^\s*([A-Za-z0-9_][A-Za-z0-9_-]*):\s*(.*)$/)){var a=n[1];r[a]=n[2].trim()}else if(e.trim())throw Error("Could not parse line ".concat(t+1,': "').concat(e,'"'))}),r},e.stringify=function(e){return Object.entries(e).reduce(function(e,r){var t,n=__read(r,2),a=n[0],o=n[1];return t=Array.isArray(o)?o.map(function(e){return"\n  - ".concat(e)}).join(""):("number"==typeof o||"boolean"==typeof o||o.match(/^\d*(\.\d+)?$/),"".concat(o)),e+"".concat(a,": ").concat(t,"\n")},"")},e}(),Module={},BergamotTranslatorWorker=function(){function e(){this.options={},this.models=new Map}return e.prototype.initialize=function(e){return __awaiter(this,void 0,void 0,function(){var r,t;return __generator(this,function(n){switch(n.label){case 0:return this.options=e||{},this.models=new Map,r=this,[4,this.loadModule()];case 1:return r.module=n.sent(),t=this,[4,this.loadTranslationService()];case 2:return t.service=n.sent(),[2]}})})},e.prototype.linkNativeIntGemm=function(r){var t=WebAssembly.mozIntGemm;if(!t)return console.warn("Native gemm requested but not available, falling back to embedded gemm"),this.linkFallbackIntGemm(r);var n=new WebAssembly.Instance(t(),{"":{memory:r.env.memory}});return Array.from(Object.keys(e.GEMM_TO_FALLBACK_FUNCTIONS_MAP)).every(function(e){return n.exports[e]})?n.exports:(console.warn("Native gemm is missing expected functions, falling back to embedded gemm"),this.linkFallbackIntGemm(r))},e.prototype.linkFallbackIntGemm=function(r){var t=Object.entries(e.GEMM_TO_FALLBACK_FUNCTIONS_MAP).map(function(e){var r=__read(e,2),t=r[0],n=r[1];return[t,function(){for(var e,r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return(e=Module.asm)[n].apply(e,__spreadArray([],__read(r),!1))}]});return Object.fromEntries(t)},e.prototype.loadModule=function(){var e=this;return new Promise(function(r,t){return __awaiter(e,void 0,void 0,function(){var e,n,a=this;return __generator(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,self.fetch(new URL("./bergamot-translator-worker.wasm",self.location.toString()))];case 1:return e=o.sent(),Object.assign(Module,{instantiateWasm:function(r,n){try{WebAssembly.instantiateStreaming(e,__assign(__assign({},r),{wasm_gemm:a.options.useNativeIntGemm?a.linkNativeIntGemm(r):a.linkFallbackIntGemm(r)})).then(function(e){var r=e.instance;return n(r)}).catch(t)}catch(e){t(e)}return{}},onRuntimeInitialized:function(){console.warn("MODULE INITIALIZED",Module),r(Module)}}),self.Module=Module,self.importScripts("bergamot-translator-worker.js"),[3,3];case 2:return n=o.sent(),t(n),[3,3];case 3:return[2]}})})})},e.prototype.loadTranslationService=function(){return new this.module.BlockingService({cacheSize:Math.max(this.options.cacheSize||0,0)})},e.prototype.hasTranslationModel=function(e){var r=e.from,t=e.to,n=JSON.stringify({from:r,to:t});return this.models.has(n)},e.prototype.loadTranslationModel=function(e,r){var t=this,n=e.from,a=e.to,o=r.vocabs.filter(function(e,r,t){return!t.slice(0,r).includes(e)}),i=__read(__spreadArray([this.prepareAlignedMemoryFromBuffer(r.model,256),this.prepareAlignedMemoryFromBuffer(r.shortlist,64),r.qualityModel?this.prepareAlignedMemoryFromBuffer(r.qualityModel,64):null],__read(o.map(function(e){return t.prepareAlignedMemoryFromBuffer(e,64)})),!1)),s=i[0],l=i[1],c=i[2],u=i.slice(3),f=new this.module.AlignedMemoryList;u.forEach(function(e){return f.push_back(e)});var m=YAML.parse("\n            beam-size: 1\n            normalize: 1.0\n            word-penalty: 0\n            cpu-threads: 0\n            gemm-precision: int8shiftAlphaAll\n            skip-cost: true\n        ");r.config&&Object.assign(m,r.config),"int8"===m["gemm-precision"]&&(m["gemm-precision"]="int8shiftAll"),Object.assign(m,YAML.parse("\n            alignment: soft\n            quiet: true\n            quiet-translation: true\n            max-length-break: 128\n            mini-batch-words: 1024\n            workspace: 128\n            max-length-factor: 2.0\n        "));var p=JSON.stringify({from:n,to:a});this.models.set(p,new this.module.TranslationModel(YAML.stringify(m),s,l,f,c))},e.prototype.freeTranslationModel=function(e){var r=e.from,t=e.to,n=JSON.stringify({from:r,to:t});if(this.models.has(n)){var a=this.models.get(n);this.models.delete(n),a&&a.delete()}},e.prototype.prepareAlignedMemoryFromBuffer=function(e,r){var t=new Int8Array(e),n=new this.module.AlignedMemory(t.byteLength,r);return n.getByteArrayView().set(t),n},e.prototype.translate=function(e){var r,t,n=this,a=e.models,o=e.texts,i=new this.module.VectorString;o.forEach(function(e){var r=e.text;return i.push_back(r)});var s=new this.module.VectorResponseOptions;o.forEach(function(e){var r=e.html,t=e.qualityScores;return s.push_back({alignment:!1,html:r,qualityScores:t})});var l=a.map(function(e){var r=e.from,t=e.to,a=JSON.stringify({from:r,to:t});return n.models.get(a)}),c=a.length>1?(r=this.service).translateViaPivoting.apply(r,__spreadArray(__spreadArray([],__read(l),!1),[i,s],!1)):(t=this.service).translate.apply(t,__spreadArray(__spreadArray([],__read(l),!1),[i,s],!1));i.delete(),s.delete();var u=o.map(function(e,r){return{target:{text:c.get(r).getTranslatedText()}}});return c.delete(),u},e.GEMM_TO_FALLBACK_FUNCTIONS_MAP={int8_prepare_a:"int8PrepareAFallback",int8_prepare_b:"int8PrepareBFallback",int8_prepare_b_from_transposed:"int8PrepareBFromTransposedFallback",int8_prepare_b_from_quantized_transposed:"int8PrepareBFromQuantizedTransposedFallback",int8_prepare_bias:"int8PrepareBiasFallback",int8_multiply_and_add_bias:"int8MultiplyAndAddBiasFallback",int8_select_columns_of_b:"int8SelectColumnsOfBFallback"},e.NATIVE_INT_GEMM="mozIntGemm",e}();function cloneError(e){return{name:e.name,message:e.message,stack:e.stack}}var worker=new BergamotTranslatorWorker;self.addEventListener("message",function(e){return __awaiter(this,void 0,void 0,function(){var r,t,n,a,o,i;return __generator(this,function(s){switch(s.label){case 0:r=e.data,t=r.id,n=r.name,a=r.args,t||console.error("Received message without id",e),s.label=1;case 1:if(s.trys.push([1,3,,4]),"function"!=typeof worker[n])throw TypeError("worker[".concat(n,"] is not a function"));return[4,Promise.resolve(Reflect.apply(worker[n],worker,a))];case 2:return o=s.sent(),self.postMessage({id:t,result:o}),[3,4];case 3:return i=s.sent(),self.postMessage({id:t,error:cloneError(i)}),[3,4];case 4:return[2]}})})});