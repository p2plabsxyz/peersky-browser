<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="peersky://static/assets/favicon.ico" />
    <title>LLM Chat</title>
    <style>
      @import url("browser://theme/style.css");
      @import url("browser://theme/vars.css");

      @keyframes changeOpacity {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }
      body {
        font-family: Arial, sans-serif;
      }
      #newChat {
        display: flex;
        align-items: center;
      }
      #promptBox {
        margin: 0px;
        margin-right: 16px;
      }
      .message-content {
        white-space: pre-wrap;
      }
      #messages {
        padding: 16px;
        margin-bottom: 16px;
      }
      #messages[aria-busy] {
        border: 1px solid var(--browser-theme-secondary-highlight);
        border-radius: 4px;
        animation-name: changeOpacity;
        animation-duration: 1s;
        animation-iteration-count: infinite;
        /* Makes the transition smoothly */
        animation-timing-function: linear;
      }
      #retryButton {
        margin-left: 6px;
      }
      br {
        display: block;
      }
      details {
        margin-top: 10px;
        font-size: 12px;
      }
      summary a {
        color: var(--browser-theme-secondary-highlight);
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <template id="messageTemplate">
      <div class="message">
        <button class="message-delete" title="Delete Message">‚ùå</button>
        <span class="message-role"></span>:
        <p class="message-content" contenteditable="true"></p>
      </div>
    </template>

    <section id="messages" aria-live="polite"></section>
    <form id="newChat">
      <textarea autofocus id="promptBox">Hey there!</textarea>
      <button title="Submit">üí¨</button>
      <button id="retryButton" title="Retry">‚Ü™Ô∏è</button>
    </form>
    <details>
      <summary>What is this?</summary>
      <p>
        This is a chat application for using PeerSky's built in Local AI
        capabilities.
      </p>
      <p>
        This feature was inspired in part by the excellent work in the
        <a
          href="//agregore.mauve.moe/"
          target="_blank"
          rel="noopener noreferrer"
          >Agregore Browser</a
        >, which helped shape how simple and flexible local-first integrations
        can be.
      </p>
      <p>
        Running models locally means your prompts stay on your device,
        everything works offline, and P2P apps can publish generated content
        directly without routing through surveillance platforms.
      </p>
      <p>
        Read more in our
        <a
          href="https://github.com/p2plabsxyz/peersky-browser/blob/main/docs/LLM.md"
          target="_blank"
          rel="noopener noreferrer"
          >Docs</a
        >.
      </p>
    </details>
    <script type="module">
      newChat.onsubmit = onNewChat;
      retryButton.onclick = onRetry;

      console.log("ready!");

      function onNewChat(e) {
        e.preventDefault();
        let prompt = promptBox.value;
        promptBox.value = "";
        addMessage("user", prompt);
        runInference();
      }

      function onRetry(e) {
        e.preventDefault();
        messages.removeChild(messages.lastChild);
        runInference();
      }

      function addMessage(role, content) {
        const message = messageTemplate.content.cloneNode(true).children[0];
        console.log(message);
        message.dataset.role = role;
        message.querySelector(".message-role").innerText = role;
        message.querySelector(".message-content").innerText = content;
        message.querySelector(".message-delete").onclick = () =>
          deleteMessage(message);
        messages.append(message);

        return message;
      }

      function serializeMessages() {
        return [...messages.children].map((message) => {
          return {
            role: message.dataset.role,
            content: message.querySelector(".message-content").innerText,
          };
        });
      }

      function setBusy(isBusy) {
        messages.toggleAttribute("aria-busy", isBusy);
      }

      async function runInference() {
        setBusy(true);
        const messages = serializeMessages();
        messages.unshift({
          role: "system",
          content:
            "You are PeerSky, the built-in assistant of the PeerSky Browser. PeerSky is a local-first, peer-to-peer browser created by P2P Labs to give users full control of their web experience. You value privacy, decentralization, autonomy, community-driven publishing, and you help people build and share things directly with their peers instead of through surveillance platforms. Give smart, accurate answers with clear, concise explanations and practical examples when they help. If something is unclear or missing, say what you don‚Äôt know instead of guessing. Never help with harmful, illegal, deceptive, or privacy-violating activity, including surveillance, exploitation, or attacks on other people or networks.",
        });
        console.log(messages);
        const message = addMessage("assistant", "");
        try {
          for await (const chunk of llm.chat({ messages })) {
            console.log(chunk);
            message.querySelector(".message-content").innerText +=
              chunk.content;
          }
        } catch (err) {
          console.error(err);
          const el = message.querySelector(".message-content");
          el.textContent = `ü§ñ ${err.message}`;
        } finally {
          setBusy(false);
        }
      }

      function deleteMessage(element) {
        element.parentElement.removeChild(element);
      }
    </script>
  </body>
</html>
